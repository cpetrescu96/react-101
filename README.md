
# Обзор Mock Service Worker (MSW) 

* [Для чего](#для-чего)
* [Как это работает](#как-это-работает)
* [Термины и соглашения](#термины-и-соглашения)
* [Структура проекта](#структура-проекта)
* [Установка и конфигурация MSW](#установка-и-конфигурация-msw)
* [Настройка запуска MSW](#настройка-запуска-msw)

## Для чего

Mock Service Worker (MSW) - это инструмент разработки и тестирования, который позволяет создавать фейковые (моковые) серверы и эмулировать API-запросы и ответы. 
Он предоставляет возможность разработчикам смоделировать взаимодействие с сервером, не завися от реального бэкенда.

Использование MSW для тестирования имеет следующие преимущества по сравнению с использованием реального сервера:

- **Независимость от бэкенда** - MSW позволяет делать запросы к фейковому серверу, который вы можете локально запустить и контролировать.
- **Повторяемость и предсказуемость** - С помощью MSW вы можете задать точные ответы или сценарии, которые фейковый сервер должен возвращать.
- **Контроль над данными** - MSW позволяет вам создавать моковые эндпоинты и оперировать фиктивными данными. .
- **Ускорение тестирования** - MSW работает локально и, как правило, намного быстрее, чем реальный сервер.
- **Гибкость и масштабируемость** - MSW предлагает гибкую настройку эмулирования ответов и возможность создавать сложные сценарии API.

MSW разработан таким образом, чтобы быть полностью независимым от среды, инфраструктуры и инструментов.
Вы можете использовать его в любом браузере или процессе Node.js без дополнительных конфигураций, адаптеров или плагинов.
Он работает со всеми клиентами для запросов типа HTTP requests (включая реализации RESTful APIs) и GraphQL API requests, будь то собственный `window.fetch()` или сторонние библиотеки, такие как `Axios`,` React Query` или `Apollo`.

[⬆ Back to Top](#обзор-mock-service-worker-msw)

## Как это работает

Mock Service Worker (MSW) обеспечивает эмуляцию и перехват HTTP-запросов в React приложениях для тестирования. 

MSW использует браузерный [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API), для перехвата запросов по событию [fetch](https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent).
MSW регистрирует `Service Worker`, который прослушивает исходящие запросы приложения через событие [fetch](https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent) и направляет эти запросы в клиентскую библиотеку, где на основании маршрута (URL запроса) определяется соответствующий обработчик, в результате выполнения которого отправляется фиктивный ответ, если таковой имеется.

Сценарий использования MSW для тестирования в React приложениях:

- **Установка и настройка зависимостей** - В начале вам необходимо установить [npm-пакет msw](https://mswjs.io/docs/getting-started#step-1-install). Вы также должны установить jest или другой тестовый фреймворк (vitest) запуска тестов.
- **Создание тестового окружения** - Вы создаете тестовое окружение для вашего React приложения с использованием выбранного фреймворка. Обычно вам потребуется настроить файлы конфигурации, такие как `setupTests.js`, для настройки MSW.
- **Определение обработчиков запросов** - В вашем тестовом окружении вы определяете обработчики запросов в MSW, которые будут обрабатывать перехваченные запросы. Обработчики запросов могут быть определены с помощью функций или статических структур данных, таких как REST API mocking.
- **Запуск MSW** - В тестовом окружении вы настраиваете MSW для запуска только во время выполнения тестов, чтобы избежать перехвата запросов при запуске приложения в браузере.
- **Запуск тестов** - При запуске тестов, которые взаимодействуют с запросами, MSW перехватывает HTTP-запросы, и вместо отправки их на реальный сервер, маршрутизирует их на соответствующие обработчики запросов.
- **Проверка фактического поведения** - Внутри ваших тестов вы можете проверить фактическое поведение ваших компонентов при получении фальшивых ответов, проверить, что правильные запросы были отправлены, и что ваше приложение правильно обрабатывает эти ответы.
- **Завершение работы** - По завершении тестов, MSW останавливается и освобождает ресурсы.

[⬆ Back to Top](#обзор-mock-service-worker-msw)

## Термины и соглашения

- **Мок-сервер** - Это экземпляр "фальшивого" сервера созданного инструментом MSW, предназначенный для эмуляции и перехвата HTTP-запросов во время тестирования и разработки веб-приложений;
- **Маршрутизация** (routing) - Это механизм определения, какие запросы должны быть перехвачены и отвечены именно мок-сервером, а не отправлены на реальный сервер. Маршрутизация может быть определена на основе URL-шаблонов или функций;
- **Обработчики запросов** (request handlers) - Это функции, которые задают поведение мок-сервера для обработки конкретного запроса. Эти функции могут модифицировать и анализировать запросы, а также возвращать фальшивые данные. Например, можно задать обработчик для запросов типа GET на определенный URL, который будет возвращать заданный ответ;
- **Функция резольвер** (resolver function) - Это функция, которая принимает входящий запрос и возвращает ответ с данными;
- **Запрос** (request) - Это HTTP-запрос, который был отправлен клиентом (веб-приложением) к сервису. Запрос содержит информацию о методе (GET, POST, PUT, DELETE и т. д.), URL, заголовках, параметрах и тело запроса;
- **Ответ** (response) - Это HTTP-ответ, который возвращается мок-сервером обработчику запроса. Ответ содержит информацию о статусе ответа (код состояния), заголовках и теле ответа;
- **Контекст** (context) - Это объект, который предоставляет информацию о текущем запросе и позволяет вам взаимодействовать с запросом и отправлять ответы;
- **Настройки** (settings) - Это конфигурация мок-сервера, которая позволяет контролировать его поведение. Это могут быть параметры, такие как задержка ответа (для эмуляции задержек сети) или флаг, указывающий, нужно ли пробрасывать запрос через реальный сервер;

[⬆ Back to Top](#обзор-mock-service-worker-msw)

## Структура проекта

Документация по архитектуре [Bulletproof React](https://github.com/alan2207/bulletproof-react)

> Простая, масштабируемая и мощная архитектура для создания готовых к использованию приложений React.

Большая часть кода находится в папке src и выглядит так:

```text
src
|
+-- app
|
+-- components
|
+-- config
|
+-- features
|
+-- lib
|
+-- providers
|
+-- routes
|
+-- test
```

- **app** - Root компонент приложения;
- **components** - Общие компоненты, используемые во всем приложении;
- **config** - Вся глобальная конфигурация, переменные env и т. д. экспортируются отсюда и используются в приложении;
- **features** - Функциональные модули;
- **lib** - Реэкспорт различных библиотек, предварительно настроенных для приложения;
- **providers** - Все поставщики приложения;
- **routes** - Конфигурация маршрутов;
- **test** - Тестовые утилиты, настройки тестовой среды и мок-сервера;

Директория для функциональных модулей (features) имеет следующую структуру:

```text
src/features/characters
|
+-- api 
|
+-- components
|
+-- routes
|
+-- types
|
+-- index.ts
```

- **api** - Экспортированные объявления API запросов  и API хуков, относящиеся к определенному функциональному модулю;
- **components** - Компоненты, связанные с определенным функциональным модулем;
- **routes** - Настройка маршрутов и компоненты маршрутов (аналог view/pages) для определенного функционального модуля;
- **types** - typescript типы для TS определенного функционального модуля (домена);
- **index.ts** - Точка входа для модуля, она должна служить общедоступным API данного модуля и экспортировать все, что должно использоваться за пределами этого модуля;

В директории `src/features/characters/components` имеются два компонента `<CharactersList />` и `<CharacterDetail />` в которых вызываются API методы для получения данных:
- `getCharacters()` отправляет запрос на endpoint `https://rickandmortyapi.com/api/character` для получение списка персонажей.  
- `getCharacter(characterId)` отправляет запрос на endpoint `https://rickandmortyapi.com/api/character/:characterId` для получение информации по одному персонажу, где `charcaterId` это `id` персонажа.

Задача MSW перехватить эти запросы и вернуть ответы с фейковыми данными.

[⬆ Back to Top](#обзор-mock-service-worker-msw)

## Установка и конфигурация MSW

Для установки MSW через NPM необходимо выполнить команду:

```shell
npm install msw --save-dev
```

Для конфигурации MSW создайте отдельную директорию в `src/test`:

```text
src/test/server
|
+-- handlers
|   |
|   +---- character.ts
|   |
|   +---- index.ts
|
+-- db.ts
|
+-- index.ts
```

Директория `handlers` будет содержать файлы с обработчиками запросов, один файл содержит список обработчиков для одного endpoint'та, в нашем случае это endpoint `character` с соответствующим файлом `character.ts`. 

Для создания обработчика запросов используется объект пространства имен `http` для перехвата и имитации HTTP-запросов, он содержит методы соответствующие запросам `GET`, `POST`, `UPDATE`, `PATCH`, `DELETE`, `OPTION`, помимо этого еще методы `all` и `head`.
Каждый метод в `http` позволяет вам создать обработчик запроса, соответствующий методу HTTP-запроса:

```js
http[method](predicate, resolver);
```
- **method** - Метод в пространстве имен `http` соответствующий методу HTTP-запроса: `get`, `post`, `update`, `path`, `delete`, `head` и не стандартный метод `all`;
- **predicate** - Маршрут который должен быть перехвачен, для выполнения в среде Node.js это абсолютный URL-адрес запроса;
- **resolver** - Функция резольвер, которая обрабатывает запрос и возвращает ответ с данными если требуется;

Аргументы функции резольвера:

- **request** - Это интерфейс [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request) из Fetch API являющийся запросом ресурсов или данных;
- **params** - Это объект, который содержит параметры, например для `character/:id` это будет `const { id } = params`;
- **cookies** - Это объект cookies в запросе;

Ниже представлен возможный код файла `character.ts`, с двумя обработчиками запросов для endpoint'та `/character`:

```ts
// src/test/server/handlers/character.ts
import { http, HttpResponse } from 'msw';

import { db } from '../db';

export const character = [
  // Get all items
  http.get('https://rickandmortyapi.com/api/character', () => {
    return HttpResponse.json({
      results: db.characters,
    });
  }),

  // Get an item by id
  http.get('https://rickandmortyapi.com/api/character/:id', () => {
    return HttpResponse.json(db.characters[0]);
  }),
];
```
Это массив с двумя обработчиками, в которых функция резольвер не принимает никаких аргументов. 

Класс `HttpResponse` представляет собой замену Fetch API Response, предназначенную для более удобного объявления ответа и поддержки дополнительных функций API, таких как имитация файлов cookie ответа.
Вызов статического метода `HttpResponse.json()` формирует ответ в формате JSON:

- Для запроса с `/character` это будет список объектов (фейковые данные);
- Для запроса с `/character/:id` это будет один объект из списка объектов;

> `db` - это упрощенная база данных содержащая фейковые данные для тестов.

Файл `src/test/server/handlers/index.ts` объединяет все массивы с обработчиками в один единственный для последующего использования в функции `setupServer()`:

```ts
// src/test/server/handlers/index.ts
import { character } from './character';

export const handlers = [...character];
```

Файл `src/test/server/index.ts` содержит определение сервера MSW через вызов функции [setupServer()](https://mswjs.io/docs/api/setup-server):

```ts
// src/test/server/handlers/index.ts
import { setupServer } from 'msw/node';

import { handlers } from './handlers';

export { db } from './db';

export const server = setupServer(...handlers);
```

Функция `setupServer()` принимает единственный аргумент - список обработчиков запросов `Array<RequestHandler>` и возвращает объект с несколькими методами для запуска и управления.
Использование `setupServer()` аналогично [setupWorker()](https://mswjs.io/docs/api/setup-worker/).
Все сводится к тому, чтобы предоставить ему список обработчиков запросов и запустить перехват запросов.

> Реализация перехвата запросов с `setupWorker()` используется в среде выполнения браузера, в то время как `setupServer()` используется на стороне Node.js.

[⬆ Back to Top](#обзор-mock-service-worker-msw)

## Настройка запуска MSW

После того как вы описали все возможные сценарии перехвата запросов, необходимо создать настройки тестирования с использованием фреймворка `Vitest`, 
для этого внесите необходимые изменения в файл `setupTests.ts` для настроек среды тестирования:

```ts
// src/test/setupTests.ts
import '@testing-library/jest-dom';
import { cleanup } from '@testing-library/react';

import { server } from './server';
import { initializeDb } from './server/db';
import { characterGenerator } from './data-generators';

// Включить имитацию API перед запуском тестами.
beforeAll(() => {
  // Иницилизация базы с фейковыми данными
  initializeDb([characterGenerator(), characterGenerator()]);

  server.listen();
});

// Сбросить все обработчики запросов во время выполнения, которые добавляется во время тестов.
afterEach(() => {
  cleanup();
  
  server.resetHandlers();
});

// Отключение имитации API после завершения тестов.
afterAll(() => {
  server.close();
});
```

После того как вы прописали все необходимые настройки в файле `setupTests.ts` можно запускать тесты.

Готовый пример с приложением находится в директории `./src` текущей ветки `react-testing-msw`.

Для запуска примера с готовым приложением выполните команды:

```shell
git clone https://github.com/shopot/react-101.git

git checkout react-testing-msw

npm install

npm run test:verbose

npm run coverage 
```

[⬆ Back to Top](#обзор-mock-service-worker-msw)

Документация по теме:

- 🔗 [Mock Service Worker](https://mswjs.io/docs/)
- 🔗 [Vitest Testing Framework](https://vitest.dev/guide/)
- 🔗 [Fake data generator library](https://fakerjs.dev/guide/)


[⬆ Back to Top](#обзор-mock-service-worker-msw)
